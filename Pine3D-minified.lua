local a=require("betterblittle")local b={}for c=1,16 do b[2^(c-1)]=("0123456789abcdef"):sub(c,c)end;local d=math.pow(10,99)local function e(f,g,h,i)local j=h-f;if j==0 then return d,-d*f end;local k=(i-g)/j;return k,g-k*f end;local l=math.min;local m=math.max;local n=math.floor;local o=math.ceil;local function p(f,g,h,i)local q={x1=f,y1=g,x2=h,y2=i,width=h-f+1,height=i-g+1,screenBuffer={{}},blittleWindow=nil,blittleOn=false,backgroundColor=colors.lightBlue}function q:setBufferSize(f,g,h,i)self.x1=f;self.y1=g;self.x2=h;self.y2=i;self.width=h-f+1;self.height=i-g+1;if self.blittleWindow then self.blittleWindow=self.blittleWindow.reposition(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)end;self:clear()end;function q:clear()local r=self.screenBuffer;r.c2={}local s=r.c2;local t=self.width;local u=self.backgroundColor;if self.blittleOn then for v=1,self.height do s[v]={}local w=s[v]for x=1,t do w[x]=u end end else local y=b[u]r.c1={}local z=r.c1;r.chars={}local A=r.chars;for v=1,self.height do z[v]={}s[v]={}A[v]={}local B=z[v]local w=s[v]local C=A[v]for x=1,t do B[x]=y;w[x]=y;C[x]=" "end end end end;function q:fastClearNormal()local D=self.backgroundColor;local r=self.screenBuffer;local A=r.chars;local z=r.c1;local s=r.c2;local D=b[D]local t=self.width;for v=1,self.height do local C=A[v]local B=z[v]local w=s[v]for x=1,t do C[x]=" "B[x]=D;w[x]=D end end end;function q:fastClearBLittle()local D=self.backgroundColor;local s=self.screenBuffer.c2;local t=self.width;for v=1,self.height do local w=s[v]for x=1,t do w[x]=D end end end;function q:setPixel(x,v,z,s,E)local x=math.floor(x+0.5)local v=math.floor(v+0.5)if x>=1 and x<=self.width then if v>=1 and v<=self.height then local r=self.screenBuffer;if self.blittleOn then r.c2[v][x]=s or z else r.c1[v][x]=b[z]r.c2[v][x]=b[s or z]r.chars[v][x]=" "end end end end;function q:image(j,F,G)for v,H in pairs(G)do for x,I in pairs(H)do if I and I>0 then if self.blittleOn then self:setPixel(x+(j-1)*2,v+(F-1)*3,I,I," ")else self:setPixel(x+j-1,v+F-1,I,I," ")end end end end end;function q:loadLineNormal(f,g,h,i,D,E,J,k,K)local r=self.screenBuffer;local z=r.c1;local s=r.c2;local A=r.chars;local L=self.width;local M=self.height;if h>=f then for x=m(o(f),1),l(n(h),L)do local v=n(k*x+K+0.5)if v>0 and v<=M then z[v][x]=J;s[v][x]=D;A[v][x]=E end end else for x=m(o(h),1),l(n(f),L)do local v=n(k*x+K+0.5)if v>0 and v<=M then z[v][x]=J;s[v][x]=D;A[v][x]=E end end end;if i>=g then for v=m(o(g),1),l(n(i),M)do local x=n((v-K)/k+0.5)if x>0 and x<=L then z[v][x]=J;s[v][x]=D;A[v][x]=E end end else for v=m(o(i),1),l(n(g),M)do local x=n((v-K)/k+0.5)if x>0 and x<=L then z[v][x]=J;s[v][x]=D;A[v][x]=E end end end end;function q:loadLineBLittle(f,g,h,i,D,k,K)local r=self.screenBuffer;local s=r.c2;local L=self.width;local M=self.height;if h>=f then for x=m(o(f),1),l(n(h),L)do local v=n(k*x+K+0.5)if v>0 and v<=M then s[v][x]=D end end else for x=m(o(h),1),l(n(f),L)do local v=n(k*x+K+0.5)if v>0 and v<=M then s[v][x]=D end end end;if i>=g then for v=m(o(g),1),l(n(i),M)do local x=n((v-K)/k+0.5)if x>0 and x<=L then s[v][x]=D end end else for v=m(o(i),1),l(n(g),M)do local x=n((v-K)/k+0.5)if x>0 and x<=L then s[v][x]=D end end end end;function q:horLineNormal(N,O,P,Q,R,S,D,E,J)local r=self.screenBuffer;local z=r.c1;local s=r.c2;local A=r.chars;local L=self.width;local M=self.height;for v=m(l(o(R),M+1),1),l(n(S),M)do local f=(v-O)/N;local h=(v-Q)/P;local B=z[v]local w=s[v]local C=A[v]if f<h then for x=m(l(n(f+0.5),L+1),1),l(h,L)do B[x]=J;w[x]=D;C[x]=E end else for x=m(l(n(h+0.5),L+1),1),l(f,L)do B[x]=J;w[x]=D;C[x]=E end end end end;function q:horLineBLittle(N,O,P,Q,R,S,D)local r=self.screenBuffer;local s=r.c2;local L=self.width;local M=self.height;for v=m(l(o(R),M+1),1),l(n(S),M)do local f=(v-O)/N;local h=(v-Q)/P;local w=s[v]if f<h then for x=m(l(n(f+0.5),L+1),1),l(h,L)do w[x]=D end else for x=m(l(n(h+0.5),L+1),1),l(f,L)do w[x]=D end end end end;local T=colors.black;function q:drawTriangleNormal(f,g,h,i,U,V,D,E,J,W)if f<0 and h<0 and U<0 or g<0 and i<0 and V<0 then return end;local L=self.width;if f>L and h>L and U>L then return end;local M=self.height;if g>M and i>M and V>M then return end;E=E or" "J=J or D;local D=b[D]local J=b[J]local N,O=e(f,g,h,i)local P,Q=e(h,i,U,V)local X,Y=e(f,g,U,V)local Z=self.horLineNormal;if g<=i and g<=V then if i<=V then if N~=0 then Z(self,N,O,X,Y,g,i,D,E,J)end;if P~=0 then Z(self,P,Q,X,Y,i,V,D,E,J)end else if X~=0 then Z(self,N,O,X,Y,g,V,D,E,J)end;if P~=0 then Z(self,N,O,P,Q,V,i,D,E,J)end end elseif i<=g and i<=V then if g<=V then if N~=0 then Z(self,N,O,P,Q,i,g,D,E,J)end;if X~=0 then Z(self,P,Q,X,Y,g,V,D,E,J)end else if P~=0 then Z(self,N,O,P,Q,i,V,D,E,J)end;if X~=0 then Z(self,N,O,X,Y,V,g,D,E,J)end end else if g<=i then if X~=0 then Z(self,P,Q,X,Y,V,g,D,E,J)end;if N~=0 then Z(self,N,O,P,Q,g,i,D,E,J)end else if P~=0 then Z(self,P,Q,X,Y,V,i,D,E,J)end;if N~=0 then Z(self,N,O,X,Y,i,g,D,E,J)end end end;local W=W;if W or self.triangleEdges then local _=self.loadLineNormal;local D=b[W or T]_(self,f,g,h,i,D,E,J,N,O)_(self,h,i,U,V,D,E,J,P,Q)_(self,U,V,f,g,D,E,J,X,Y)end end;function q:drawTriangleBLittle(f,g,h,i,U,V,D,E,J,W)if f<0 and h<0 and U<0 or g<0 and i<0 and V<0 then return end;local L=self.width;if f>L and h>L and U>L then return end;local M=self.height;if g>M and i>M and V>M then return end;local N,O=e(f,g,h,i)local P,Q=e(h,i,U,V)local X,Y=e(f,g,U,V)local Z=self.horLineBLittle;if g<=i and g<=V then if i<=V then if N~=0 then Z(self,N,O,X,Y,g,i,D)end;if P~=0 then Z(self,P,Q,X,Y,i,V,D)end else if X~=0 then Z(self,N,O,X,Y,g,V,D)end;if P~=0 then Z(self,N,O,P,Q,V,i,D)end end elseif i<=g and i<=V then if g<=V then if N~=0 then Z(self,N,O,P,Q,i,g,D)end;if X~=0 then Z(self,P,Q,X,Y,g,V,D)end else if P~=0 then Z(self,N,O,P,Q,i,V,D)end;if X~=0 then Z(self,N,O,X,Y,V,g,D)end end else if g<=i then if X~=0 then Z(self,P,Q,X,Y,V,g,D)end;if N~=0 then Z(self,N,O,P,Q,g,i,D)end else if P~=0 then Z(self,P,Q,X,Y,V,i,D)end;if N~=0 then Z(self,N,O,X,Y,i,g,D)end end end;local W=W;if W or self.triangleEdges then local _=self.loadLineBLittle;local D=W or T;_(self,f,g,h,i,D,N,O)_(self,h,i,U,V,D,P,Q)_(self,U,V,f,g,D,X,Y)end end;function q:drawBufferNormal()local f=self.x1;local g=self.y1;local r=self.screenBuffer;local a0=term.setCursorPos;local a1=term.blit;local A=r.chars;local z=r.c1;local s=r.c2;local a2=table.concat;for v=1,self.height do a0(f,v+g-1)local A=a2(A[v])local z=a2(z[v])local s=a2(s[v])a1(A,z,s)end end;function q:drawBufferBLittle()local a3=self.blittleWindow;if not a3 then self.blittleWindow=window.create(term.current(),self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1,false)a3=self.blittleWindow end;a.drawBuffer(self.screenBuffer.c2,a3)a3.setVisible(true)a3.setVisible(false)end;function q:highResMode(a4)self.blittleOn=a4;self.drawTriangle=a4 and self.drawTriangleBLittle or self.drawTriangleNormal;self.fastClear=a4 and self.fastClearBLittle or self.fastClearNormal;self.drawBuffer=a4 and self.drawBufferBLittle or self.drawBufferNormal;self:clear()end;function q:useTriangleEdges(a4)self.triangleEdges=a4 end;q:highResMode(true)return q end;local a5=math.sqrt;local a6=table.sort;local function a7(a8)local a9=a8[1][16]for c=2,#a8 do local aa=a8[c][16]if aa>a9 then return false end;a9=aa end;return true end;local function ab(a8,ac,ad,ae,af)local ag=af[1]local ah=af[2]local ai=af[3]local aj=ac and ac-ag or 0;local ak=ad and ad-ah or 0;local al=ae and ae-ai or 0;for c=1,#a8 do local am=a8[c]local an=aj+(am[1]+am[4]+am[7])/3;local ao=ak+(am[2]+am[5]+am[8])/3;local ap=al+(am[3]+am[6]+am[9])/3;am[16]=an*an+ao*ao+ap*ap end;if not a7(a8)then a6(a8,function(k,K)return k[16]>K[16]end)end end;local aq=math.rad;local ar=math.sin;local as=math.cos;local at=math.atan2;local function au(x,v,av,aw)local ax=at(v+0.0000001,av+0.0000001)local ay=ax+aw;while ay>180 do ay=ay-360 end;while ay<-180 do ay=ay+360 end;local az=a5(v*v+av*av)local v=az*ar(ay)local av=az*as(ay)return x,v,av end;local function aA(x,v,av,aB)local ax=at(x+0.0000001,av+0.0000001)local ay=ax+aB;while ay>180 do ay=ay-360 end;while ay<-180 do ay=ay+360 end;local az=a5(x*x+av*av)local x=az*ar(ay)local av=az*as(ay)return x,v,av end;local function aC(x,v,av,aD)local ax=at(x+0.0000001,v+0.0000001)local ay=ax+aD;while ay>180 do ay=ay-360 end;while ay<-180 do ay=ay+360 end;local az=a5(x*x+v*v)local x=az*ar(ay)local v=az*as(ay)return x,v,av end;local function aE(aF,aw)local aG={}for aH,am in pairs(aF)do local f,g,aI=au(am[1],am[2],am[3],aw)local h,i,aJ=au(am[4],am[5],am[6],aw)local U,V,aK=au(am[7],am[8],am[9],aw)aG[#aG+1]={f,g,aI,h,i,aJ,U,V,aK}aG[#aG][10]=am[10]aG[#aG][11]=am[11]aG[#aG][12]=am[12]aG[#aG][13]=am[13]aG[#aG][14]=am[14]end;return aG end;local function aL(aF,aB)local aG={}for aH,am in pairs(aF)do local f,g,aI=aA(am[1],am[2],am[3],aB)local h,i,aJ=aA(am[4],am[5],am[6],aB)local U,V,aK=aA(am[7],am[8],am[9],aB)aG[#aG+1]={f,g,aI,h,i,aJ,U,V,aK}aG[#aG][10]=am[10]aG[#aG][11]=am[11]aG[#aG][12]=am[12]aG[#aG][13]=am[13]aG[#aG][14]=am[14]end;return aG end;local function aM(aF,aD)local aG={}for aH,am in pairs(aF)do local f,g,aI=aC(am[1],am[2],am[3],aD)local h,i,aJ=aC(am[4],am[5],am[6],aD)local U,V,aK=aC(am[7],am[8],am[9],aD)aG[#aG+1]={f,g,aI,h,i,aJ,U,V,aK}aG[#aG][10]=am[10]aG[#aG][11]=am[11]aG[#aG][12]=am[12]aG[#aG][13]=am[13]aG[#aG][14]=am[14]end;return aG end;local function aN(aO,af)local aP=af[1]local aQ=af[2]local aR=af[3]for c=1,#aO do local aS=aO[c]local aT=aS[1]local aU=aS[2]local aV=aS[3]local aW=aT and aT-aP or 0;local aX=aU and aU-aQ or 0;local aY=aV and aV-aR or 0;aS[9]=aW*aW+aX*aX+aY*aY end;a6(aO,function(k,K)return k[9]>K[9]end)end;local function aZ(a_)local b0=fs.open(a_,"r")if not b0 then error("Could not find model for an object at path: "..a_)end;local b1=b0.readAll()b0.close()return textutils.unserialise(b1)end;local b2=math.pi;local ar=math.sin;local as=math.cos;local b3=math.tan;local a5=math.sqrt;local function b4(f,g,h,i)local t,b5=term.getSize()if f and h then t=h-f+1 end;if g and i then b5=i-g+1 end;local f=f or 1;local g=g or 1;local h=h or t-f+1;local i=i or b5-g+1;local b6={camera={0.000001,0.000001,0.000001,nil,0,0},buffer=p(f,g,h,i),x1=f,y1=g,x2=h,y2=i,width=t,height=b5,blittleOn=false,pixelratio=1.5}b6.FoV=90;b6.camera[7]=aq(b6.FoV)b6.t=b3(aq(b6.FoV/2))*2*0.0001;function b6:setBackgroundColor(D)local b7=self.buffer;b7.backgroundColor=D;b7:fastClear()end;function b6:setSize(f,g,h,i)self.x1=f;self.y1=g;self.x2=h;self.y2=i;if not self.blittleOn then self.buffer:setBufferSize(f,g,h,i)self.width=h-f+1;self.height=i-g+1;self.pixelratio=1.5 else self.width=(h-f+1)*2;self.height=(i-g+1)*3;self.pixelratio=1;self.buffer:setBufferSize(f,g,f+self.width-1,g+self.height-1)end;self:updateMappingConstants()end;function b6:highResMode(a4)self.blittleOn=a4;self.buffer:highResMode(a4)if a4 then self.width=(self.x2-self.x1+1)*2;self.height=(self.y2-self.y1+1)*3;self.buffer:setBufferSize(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)self.pixelratio=1 else self.buffer:setBufferSize(self.x1,self.y1,self.x2,self.y2)self.width=self.x2-self.x1+1;self.height=self.y2-self.y1+1;self.pixelratio=1.5 end;self:updateMappingConstants()end;function b6:loadModelRaw(aF)local b8={}local b9=0;for c=1,#aF do local am=aF[c]b8[#b8+1]={}b8[#b8][1]=am.x1;b8[#b8][2]=am.y1;b8[#b8][3]=am.z1;b8[#b8][4]=am.x2;b8[#b8][5]=am.y2;b8[#b8][6]=am.z2;b8[#b8][7]=am.x3;b8[#b8][8]=am.y3;b8[#b8][9]=am.z3;b8[#b8][10]=am.forceRender;b8[#b8][11]=am.c;b8[#b8][12]=am.char;b8[#b8][13]=am.charc;b8[#b8][14]=am.outlineColor;b8[#b8][15]=c;local ba=a5(am.x1*am.x1+am.y1*am.y1+am.z1*am.z1)local bb=a5(am.x2*am.x2+am.y2*am.y2+am.z2*am.z2)local bc=a5(am.x3*am.x3+am.y3*am.y3+am.z3*am.z3)if ba>b9 then b9=ba end;if bb>b9 then b9=bb end;if bc>b9 then b9=bc end end;return b8,b9 end;function b6:updateMappingConstants()self.renderOffsetX=n(self.width*0.5)+1;self.renderOffsetY=n(self.height*0.5)self.sXFactor=0.0001*self.width/self.t;self.sYFactor=-0.0001*self.width/(self.t*self.height*self.pixelratio)*self.height end;function b6:map3dTo2d(x,v,av)local af=self.camera;local bd=ar(af[4]or 0)local be=as(af[4]or 0)local bf=ar(-af[5])local bg=as(-af[5])local bh=ar(af[6])local bi=as(af[6])local aW=x-af[1]local aX=v-af[2]local aY=av-af[3]local bj=bg*aW-bf*aY;aY=bf*aW+bg*aY;aW=bj;local bk=bi*aX-bh*aW;aW=bh*aX+bi*aW;aX=bk;if bd~=0 then local bl=bd*aY-be*aX;aX=be*aY+bd*aX;aY=bl end;local bm=aY/aW*self.sXFactor+self.renderOffsetX;local bn=aX/aW*self.sYFactor+self.renderOffsetY;return bm,bn,aW>=0.0001 end;function b6:drawObject(aS,af,bo)local aT=aS[1]local aU=aS[2]local aV=aS[3]local bd=bo[1]local be=bo[2]local bf=bo[3]local bg=bo[4]local bh=bo[5]local bi=bo[6]local bp=aT and aT-af[1]or 0;local bq=aU and aU-af[2]or 0;local br=aV and aV-af[3]or 0;local aF=aS[7]if#aF<=0 then return end;local bs=aS[8]local aW=bp;local aX=bq;local aY=br;local bj=bg*aW-bf*aY;local aY=bf*aW+bg*aY;local aW=bj;local aW=bh*aX+bi*aW;if aW<-bs then return end;local bt=0.5*af[7]local bu=ar(bt)local bv=as(bt)if(aW+bs)*bu+(aY+bs)*bv<0 then return end;if(aW+bs)*bu-(aY-bs)*bv<0 then return end;local bw=aS[5]if bw and bw~=0 then aF=aL(aF,bw)end;local bx=aS[6]if bx and bx~=0 then aF=aM(aF,bx)end;local by=aS[4]if by and by~=0 then aF=aE(aF,by)end;ab(aF,aT,aU,aV,af)local bz=bp*bp+bq*bq+br*br<bs*bs*4;local bA=self.renderOffsetX;local bB=self.renderOffsetY;local bC=self.sXFactor;local bD=self.sYFactor;local bd=bd;local be=be;local bf=bf;local bg=bg;local bh=bh;local bi=bi;local bp=bp;local bq=bq;local br=br;local function bE(x,v,av)local aW=x+bp;local aX=v+bq;local aY=av+br;local bj=bg*aW-bf*aY;aY=bf*aW+bg*aY;aW=bj;local bk=bi*aX-bh*aW;aW=bh*aX+bi*aW;aX=bk;local bm=aY/aW*bC+bA;local bn=aX/aW*bD+bB;return bm,bn,aW,aX,aY end;local function bF(x,v,av)local aW=x+bp;local aX=v+bq;local aY=av+br;local bj=bg*aW-bf*aY;aY=bf*aW+bg*aY;aW=bj;local bk=bi*aX-bh*aW;aW=bh*aX+bi*aW;aX=bk;local bm=aY/aW*bC+bA;local bn=aX/aW*bD+bB;return bm,bn,aW end;if bd~=0 then function bE(x,v,av)local aW=x+bp;local aX=v+bq;local aY=av+br;local bj=bg*aW-bf*aY;aY=bf*aW+bg*aY;aW=bj;local bk=bi*aX-bh*aW;aW=bh*aX+bi*aW;aX=bk;local bl=bd*aY-be*aX;aX=be*aY+bd*aX;aY=bl;local bm=aY/aW*bC+bA;local bn=aX/aW*bD+bB;return bm,bn,aW,aX,aY end;function bF(x,v,av)local aW=x+bp;local aX=v+bq;local aY=av+br;local bj=bg*aW-bf*aY;aY=bf*aW+bg*aY;aW=bj;local bk=bi*aX-bh*aW;aW=bh*aX+bi*aW;aX=bk;local bl=bd*aY-be*aX;aX=be*aY+bd*aX;aY=bl;local bm=aY/aW*bC+bA;local bn=aX/aW*bD+bB;return bm,bn,aW end end;local bG=aF;local b7=self.buffer;for c=1,#bG do local am=bG[c]local f,g,bH=bF(am[1],am[2],am[3])if bH>0.00010000001 then local h,i,bj=bF(am[4],am[5],am[6])if bj>0.00010000001 then local U,V,bI=bF(am[7],am[8],am[9])if bI>0.00010000001 then if am[10]or(h-f)*(V-i)-(i-g)*(U-h)<0 then b7:drawTriangle(f,g,h,i,U,V,am[11],am[12],am[13],am[14])end elseif bz then local f,g,bH,bJ,bK=bE(am[1],am[2],am[3])local h,i,bj,bk,bl=bE(am[4],am[5],am[6])local U,V,bI,bL,bM=bE(am[7],am[8],am[9])local bN=math.abs;local bO=bN(bI-0.0001)local bP=bN(bH-0.0001)local bQ=bP+bO;local bR=(bM*bP+bK*bO)/bQ;local bS=(bL*bP+bJ*bO)/bQ;local bA,bC,bB,bD=bA,bC,bB,bD;local bT=bR*10000*bC+bA;local bU=bS*10000*bD+bB;if am[10]or(h-f)*(bU-i)-(i-g)*(bT-h)<0 then b7:drawTriangle(f,g,h,i,bT,bU,am[11],am[12],am[13],am[14])local bV=bN(bj-0.0001)local bQ=bV+bO;local bR=(bl*bO+bM*bV)/bQ;local bS=(bk*bO+bL*bV)/bQ;local bW=bR*10000*bC+bA;local bX=bS*10000*bD+bB;b7:drawTriangle(bW,bX,h,i,bT,bU,am[11],am[12],am[13],am[14])end end elseif bz then local f,g,bH,bJ,bK=bE(am[1],am[2],am[3])local h,i,bj,bk,bl=bE(am[4],am[5],am[6])local U,V,bI,bL,bM=bE(am[7],am[8],am[9])local bN=math.abs;if bI>0.00010000001 then local bV=bN(bj-0.0001)local bP=bN(bH-0.0001)local bQ=bP+bV;local bR=(bl*bP+bK*bV)/bQ;local bS=(bk*bP+bJ*bV)/bQ;local bA,bC,bB,bD=bA,bC,bB,bD;local bT=bR*10000*bC+bA;local bU=bS*10000*bD+bB;if am[10]or(bT-f)*(V-bU)-(bU-g)*(U-bT)<0 then b7:drawTriangle(f,g,bT,bU,U,V,am[11],am[12],am[13],am[14])local bO=bN(bI-0.0001)local bQ=bV+bO;local bR=(bl*bO+bM*bV)/bQ;local bS=(bk*bO+bL*bV)/bQ;local bW=bR*10000*bC+bA;local bX=bS*10000*bD+bB;b7:drawTriangle(bW,bX,bT,bU,U,V,am[11],am[12],am[13],am[14])end else local bP=bN(bH-0.0001)local bV=bN(bj-0.0001)local bO=bN(bI-0.0001)local bY=bP+bV;local bZ=bP+bO;local bR=(bK*bV+bl*bP)/bY;local bS=(bJ*bV+bk*bP)/bY;local bA,bC,bB,bD=bA,bC,bB,bD;local bT=bR*10000*bC+bA;local bU=bS*10000*bD+bB;local b_=(bK*bO+bM*bP)/bZ;local c0=(bJ*bO+bL*bP)/bZ;local bW=b_*10000*bC+bA;local bX=c0*10000*bD+bB;if am[10]or(bT-f)*(bX-bU)-(bU-g)*(bW-bT)<0 then b7:drawTriangle(f,g,bT,bU,bW,bX,am[11],am[12],am[13],am[14])end end end elseif bz then local f,g,bH,bJ,bK=bE(am[1],am[2],am[3])local h,i,bj,bk,bl=bE(am[4],am[5],am[6])local U,V,bI,bL,bM=bE(am[7],am[8],am[9])local bN=math.abs;if bj>0.00010000001 then if bI>0.00010000001 then local bP=bN(bH-0.0001)local bV=bN(bj-0.0001)local bQ=bP+bV;local bR=(bK*bV+bl*bP)/bQ;local bS=(bJ*bV+bk*bP)/bQ;local bA,bC,bB,bD=bA,bC,bB,bD;local bT=bR*10000*bC+bA;local bU=bS*10000*bD+bB;if am[10]or(h-bT)*(V-i)-(i-bU)*(U-h)<0 then b7:drawTriangle(bT,bU,h,i,U,V,am[11],am[12],am[13],am[14])local bO=bN(bI-0.0001)local bQ=bP+bO;local bR=(bK*bO+bM*bP)/bQ;local bS=(bJ*bO+bL*bP)/bQ;local bW=bR*10000*bC+bA;local bX=bS*10000*bD+bB;b7:drawTriangle(bT,bU,bW,bX,U,V,am[11],am[12],am[13],am[14])end else local bP=bN(bH-0.0001)local bV=bN(bj-0.0001)local bO=bN(bI-0.0001)local bY=bV+bP;local bZ=bV+bO;local bR=(bK*bV+bl*bP)/bY;local bS=(bJ*bV+bk*bP)/bY;local bA,bC,bB,bD=bA,bC,bB,bD;local bT=bR*10000*bC+bA;local bU=bS*10000*bD+bB;local b_=(bl*bO+bM*bV)/bZ;local c0=(bk*bO+bL*bV)/bZ;local bW=b_*10000*bC+bA;local bX=c0*10000*bD+bB;if am[10]or(h-bT)*(bX-i)-(i-bU)*(bW-h)<0 then b7:drawTriangle(bT,bU,h,i,bW,bX,am[11],am[12],am[13],am[14])end end else if bI>0.00010000001 then local bP=bN(bH-0.0001)local bV=bN(bj-0.0001)local bO=bN(bI-0.0001)local bY=bO+bP;local bZ=bO+bV;local bR=(bK*bO+bM*bP)/bY;local bS=(bJ*bO+bL*bP)/bY;local bA,bC,bB,bD=bA,bC,bB,bD;local bT=bR*10000*bC+bA;local bU=bS*10000*bD+bB;local b_=(bl*bO+bM*bV)/bZ;local c0=(bk*bO+bL*bV)/bZ;local bW=b_*10000*bC+bA;local bX=c0*10000*bD+bB;if am[10]or(bW-bT)*(V-bX)-(bX-bU)*(U-bW)<0 then b7:drawTriangle(bT,bU,bW,bX,U,V,am[11],am[12],am[13],am[14])end end end end end end;function b6:drawObjects(aO)local af=self.camera;local bo={ar(af[4]or 0),as(af[4]or 0),ar(-af[5]),as(-af[5]),ar(af[6]),as(af[6])}aN(aO,af)local aO=aO;for c=1,#aO do self:drawObject(aO[c],af,bo)end end;function b6:drawBuffer()local b7=self.buffer;b7:drawBuffer()b7:fastClear()end;function b6:setCamera(c1,c2,c3,by,bw,bx)local aq=math.rad;if type(c1)=="table"then local af=c1;self.camera={af.x or self.camera[1]or 0,af.y or self.camera[2]or 0,af.z or self.camera[3]or 0,af.rotX and aq(af.rotX+90)or self.camera[4]or 0,af.rotY and aq(af.rotY)or self.camera[5]or 0,af.rotZ and aq(af.rotZ)or self.camera[6]or 0,self.camera[7]}else self.camera={c1 or self.camera[1]or 0,c2 or self.camera[2]or 0,c3 or self.camera[3]or 0,by and aq(by+90)or self.camera[4]or 0,bw and aq(bw)or self.camera[5]or 0,bx and aq(bx)or self.camera[6]or 0,self.camera[7]}end;if self.camera[4]==math.pi*0.5 then self.camera[4]=nil end end;function b6:setFoV(bt)self.FoV=bt or 90;self.t=b3(aq(self.FoV/2))*2*0.0001;self:updateMappingConstants()self.camera[7]=aq(self.FoV)end;function b6:setWireFrame(a4)self.buffer:useTriangleEdges(a4)end;function b6:getObjectIndexTrace(aO,x,v)local function c4(c5,c6,c7)return(c5.x-c7.x)*(c6.y-c7.y)-(c6.x-c7.x)*(c5.y-c7.y)end;local function c8(c9,ca,f,g,h,i,U,V,cb,cc,cd,ce)local O=c4({x=c9,y=ca},{x=f,y=g},{x=h,y=i})<0;local Q=c4({x=c9,y=ca},{x=h,y=i},{x=U,y=V})<0;local Y=c4({x=c9,y=ca},{x=U,y=V},{x=f,y=g})<0;return O==Q and Q==Y end;local v=v-1;local cf={}if self.blittleOn then x=x*2;v=v*3+1 end;local af=self.camera;local bo={ar(af[4]or 0),as(af[4]or 0),ar(-af[5]),as(-af[5]),ar(af[6]),as(af[6])}local bd=bo[1]local be=bo[2]local bf=bo[3]local bg=bo[4]local bh=bo[5]local bi=bo[6]for c=1,#aO do local aS=aO[c]local aF=aS[7]local aG=aS[5]and aS[5]~=0 and rotateModel(aF,aS[5])or aF;local aT=aS[1]local aU=aS[2]local aV=aS[3]local bA=self.renderOffsetX;local bB=self.renderOffsetY;local bC=self.sXFactor;local bD=self.sYFactor;local bd=bd;local be=be;local bf=bf;local bg=bg;local bh=bh;local bi=bi;local bp=aT-af[1]local bq=aU-af[2]local br=aV-af[3]local function bF(x,v,av)local aW=x+bp;local aX=v+bq;local aY=av+br;local bj=bg*aW-bf*aY;aY=bf*aW+bg*aY;aW=bj;local bk=bi*aX-bh*aW;aW=bh*aX+bi*aW;aX=bk;if bd~=0 then local bl=bd*aY-be*aX;aX=be*aY+bd*aX;aY=bl end;local bm=aY/aW*bC+bA;local bn=aX/aW*bD+bB;return bm,bn,aW>0 end;for cg=1,#aG do local am=aG[cg]local f,g,ch=bF(am[1],am[2],am[3])if ch then local h,i,ci=bF(am[4],am[5],am[6])if ci then local U,V,cj=bF(am[7],am[8],am[9])if cj then if am[10]or(h-f)*(V-i)-(i-g)*(U-h)<0 then if not self.blittleOn then if c8(x,v,f,g,h,i,U,V,self.x1,self.y1,self.x2,self.y2)then cf[#cf+1]={objectIndex=c,polygonIndex=am[15]}end else if c8(x,v,f,g,h,i,U,V,(self.x2-1)*2+1,(self.y1-1)*3+1,self.x2*2,(self.y2+1)*3)then cf[#cf+1]={objectIndex=c,polygonIndex=am[15]}end end end end end end end end;if#cf<=0 then return elseif#cf==1 then return cf[1].objectIndex,cf[1].polygonIndex end;local ck={}local cl=-1;local cm=math.huge;for c=1,#cf do local aS=aO[cf[c].objectIndex]local aW=af[1]-aS[1]local aX=af[2]-aS[2]local aY=af[3]-aS[3]local cn=a5(aW*aW+aX*aX+aY*aY)if cn<cm then cm=cn;cl=cf[c].objectIndex end end;for c=1,#cf do local aS=aO[cf[c].objectIndex]local aW=af[1]-aS[1]local aX=af[2]-aS[2]local aY=af[3]-aS[3]local cn=a5(aW*aW+aX*aX+aY*aY)if cn==cm then ck[#ck+1]=cf[c].polygonIndex end end;local aS=aO[cl]local aF=aS[7]local co=-1;local cp=math.huge;local aj=aS[1]-af[1]local ak=aS[2]-af[2]local al=aS[3]-af[3]for c=1,#ck do local cq=ck[c]local am=aF[cq]local an=aj+(am[1]+am[4]+am[7])/3;local ao=ak+(am[2]+am[5]+am[8])/3;local ap=al+(am[3]+am[6]+am[9])/3;local cn=a5(an*an+ao*ao+ap*ap)if cn<cp then cp=cn;co=ck[c]end end;return cl,co end;function b6:newObject(cr,x,v,av,by,bw,bx)local aF=nil;local bs=nil;if type(cr)=="table"then aF,bs=self:loadModelRaw(cr)else local cs=aZ(cr)aF,bs=self:loadModelRaw(cs)end;local aS={x,v,av,by,bw,bx,aF,bs}aS.frame=self;function aS:setPos(x,v,av)self[1]=x or self[1]self[2]=v or self[2]self[3]=av or self[3]end;function aS:setRot(by,bw,bx)self[4]=by or self[4]self[5]=bw or self[5]self[6]=bx or self[6]end;function aS:setModel(cr)if type(cr)=="table"then aF,bs=self.frame:loadModelRaw(cr)self[7]=aF;self[8]=bs else local cs=aZ(cr)aF,bs=self.frame:loadModelRaw(cs)self[7]=aF;self[8]=bs end end;return aS end;b6:updateMappingConstants()b6:highResMode(true)return b6 end;local ct={}local function cu(f,g,aI,h,i,aJ,U,V,aK,D)return{x1=f,y1=g,z1=aI,x2=h,y2=i,z2=aJ,x3=U,y3=V,z3=aK,c=D}end;function ct:cube(cv)cv.color=cv.color or colors.red;return{cu(-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,cv.bottom or cv.color),cu(-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,cv.bottom2 or cv.bottom or cv.color),cu(-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,cv.top or cv.color),cu(-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,cv.top or cv.color),cu(-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,cv.side or cv.color),cu(-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,cv.side2 or cv.side or cv.color),cu(.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,cv.side or cv.color),cu(.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,cv.side2 or cv.side or cv.color),cu(-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,cv.side or cv.color),cu(-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,cv.side2 or cv.side or cv.color),cu(-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,cv.side or cv.color),cu(.5,-.5,.5,.5,.5,.5,-.5,.5,.5,cv.side2 or cv.side or cv.color)}end;function ct:sphere(cv)cv.res=cv.res or 32;cv.color=cv.color or colors.red;local cw=1/cv.res;local aF={}local cx={}for c=0,cv.res do local v=0.5*as(c/cv.res*b2)local cy={}for cg=0,cv.res do local cz=0.5*a5(1-v*2*v*2)local x=as(cg/cv.res*b2*2)*cz;local av=ar(cg/cv.res*b2*2)*cz;local h=as((cg+1)/cv.res*b2*2)*cz;local aJ=ar((cg+1)/cv.res*b2*2)*cz;if cx[cg]then aF[#aF+1]={x1=cx[(cg+1)%cv.res].x,y1=cx[(cg+1)%cv.res].y,z1=cx[(cg+1)%cv.res].z,x2=x,y2=v,z2=av,x3=cx[cg].x,y3=cx[cg].y,z3=cx[cg].z,c=cv.color}aF[#aF+1]={x1=h,y1=v,z1=aJ,x2=x,y2=v,z2=av,x3=cx[(cg+1)%cv.res].x,y3=cx[(cg+1)%cv.res].y,z3=cx[(cg+1)%cv.res].z,c=cv.color2 or cv.color}end;cy[cg]={x=x,y=v,z=av}end;cx=cy end;if cv.colors or cv.top or cv.bottom then for c=1,#aF do local cA=aF[c]local ao=(cA.y1+cA.y2+cA.y3)/3;if cv.colors then local cB=n((-ao+0.5)*#cv.colors+1)cA.c=cv.colors[cB]or cA.c else if ao>=0 then cA.c=cv.top or cA.c else cA.c=cv.bottom or cA.c end end end end;return aF end;function ct:icosphere(cv)cv.res=cv.res or 1;local cC=(1+a5(5))/2;local cD={{cC,1,0},{cC,-1,0},{-cC,-1,0},{-cC,1,0},{1,0,cC},{-1,0,cC},{-1,0,-cC},{1,0,-cC},{0,cC,1},{0,cC,-1},{0,-cC,-1},{0,-cC,1}}local function cE(cF,cG,cH)return cu(cD[cF][1],cD[cF][2],cD[cF][3],cD[cG][1],cD[cG][2],cD[cG][3],cD[cH][1],cD[cH][2],cD[cH][3],cv.colors and 1 or cv.color)end;local aF={cE(11,2,12),cE(11,8,2),cE(11,7,8),cE(11,3,7),cE(11,12,3),cE(4,7,3),cE(4,10,7),cE(4,9,10),cE(4,6,9),cE(4,3,6),cE(5,6,12),cE(5,9,6),cE(5,1,9),cE(5,2,1),cE(5,12,2),cE(3,12,6),cE(1,8,10),cE(1,10,9),cE(1,2,8),cE(10,8,7)}local function cI()local cJ={}for c=1,#aF do local cA=aF[c]local cK={x=(cA.x1+cA.x2)/2,y=(cA.y1+cA.y2)/2,z=(cA.z1+cA.z2)/2}local cL={x=(cA.x1+cA.x3)/2,y=(cA.y1+cA.y3)/2,z=(cA.z1+cA.z3)/2}local cM={x=(cA.x2+cA.x3)/2,y=(cA.y2+cA.y3)/2,z=(cA.z2+cA.z3)/2}local cN=cA.c;if cv.colorsFractal then cN=cN%#cv.colors+1 end;cJ[#cJ+1]=cu(cK.x,cK.y,cK.z,cM.x,cM.y,cM.z,cL.x,cL.y,cL.z,cA.c)cJ[#cJ+1]=cu(cA.x1,cA.y1,cA.z1,cK.x,cK.y,cK.z,cL.x,cL.y,cL.z,cN)cJ[#cJ+1]=cu(cK.x,cK.y,cK.z,cA.x2,cA.y2,cA.z2,cM.x,cM.y,cM.z,cN)cJ[#cJ+1]=cu(cL.x,cL.y,cL.z,cM.x,cM.y,cM.z,cA.x3,cA.y3,cA.z3,cN)end;aF=cJ end;for c=1,cv.res-1 do cI()end;local function cO(x,v,av)local cP=math.sqrt(x*x+v*v+av*av)local cQ=0.5/cP;return x*cQ,v*cQ,av*cQ end;for c=1,#aF do local cA=aF[c]cA.x1,cA.y1,cA.z1=cO(cA.x1,cA.y1,cA.z1)cA.x2,cA.y2,cA.z2=cO(cA.x2,cA.y2,cA.z2)cA.x3,cA.y3,cA.z3=cO(cA.x3,cA.y3,cA.z3)if not cv.colorsFractal then local ao=(cA.y1+cA.y2+cA.y3)/3;if cv.colors then local cB=math.floor((-ao+0.5)*#cv.colors+1)cA.c=cv.colors[cB]or cA.c else if ao>=0 then cA.c=cv.top or cA.c else cA.c=cv.bottom or cA.c end end else cA.c=cv.colors[cA.c]end end;return aF end;function ct:plane(cv)cv.color=cv.color or colors.lime;cv.size=cv.size or 1;cv.y=cv.y or 0;return{cu(-1*cv.size,cv.y,1*cv.size,1*cv.size,cv.y,-1*cv.size,-1*cv.size,cv.y,-1*cv.size,cv.color),cu(-1*cv.size,cv.y,1*cv.size,1*cv.size,cv.y,1*cv.size,1*cv.size,cv.y,-1*cv.size,cv.color)}end;function ct:mountains(cv)cv.res=cv.res or 20;cv.randomOffset=cv.randomOffset or 0;cv.height=cv.height or 1;cv.randomHeight=cv.randomHeight or 0;cv.y=cv.y or 0;cv.scale=cv.scale or 100;cv.color=cv.color or colors.green;cv.snowColor=cv.snowColor or colors.white;local cR=3/cv.res*cv.height/(cv.randomHeight+1)local cS=3/cv.res*cv.height*(cv.randomHeight+1)local aF={}for c=0,cv.res do local cT=math.random(-cv.randomOffset*100,cv.randomOffset*100)/100;local cU=c+cT;local f=as((cU-1)/cv.res*b2*2)*cv.scale;local aI=ar((cU-1)/cv.res*b2*2)*cv.scale;local h=as((cU-0.5)/cv.res*b2*2)*cv.scale;local aJ=ar((cU-0.5)/cv.res*b2*2)*cv.scale;local U=as(cU/cv.res*b2*2)*cv.scale;local aK=ar(cU/cv.res*b2*2)*cv.scale;local cV=math.random(cR*100,cS*100)/100*cv.scale;local am={x1=f,y1=cv.y,z1=aI,x2=U,y2=cv.y,z2=aK,x3=h,y3=cv.y+cV,z3=aJ,c=cv.color,forceRender=true}aF[#aF+1]=am;if cv.snow then local cW=0.93;local cX=cv.snowHeight or 0.5;local cY=1-cX*cS/(cV/cv.scale)cY=m(0,l(1,cY))if cY>0.2 then local cZ={x1=(f*cY+h*(1-cY))*cW,y1=cv.y+cV*(1-cY),z1=(aI*cY+aJ*(1-cY))*cW,x2=(U*cY+h*(1-cY))*cW,y2=cv.y+cV*(1-cY),z2=(aK*cY+aJ*(1-cY))*cW,x3=h*cW,y3=cv.y+cV,z3=aJ*cW,c=cv.snowColor,forceRender=true}aF[#aF+1]=cZ end end end;return aF end;local c_={}function c_:invertTriangles(aF)if not aF or type(aF)~="table"then error("transforms:invertTriangles expected arg#1 to be a table (model)")end;local cJ={}for c=1,#aF do local d0=aF[c]local d1={x1=d0.x1,y1=d0.y1,z1=d0.z1,x2=d0.x3,y2=d0.y3,z2=d0.z3,x3=d0.x2,y3=d0.y2,z3=d0.z2,c=d0.c,char=d0.char,charc=d0.charc,forceRender=d0.forceRender,outlineColor=d0.outlineColor}cJ[c]=d1 end;return cJ end;function c_:setOutline(aF,cv)if not aF or type(aF)~="table"then error("transforms:invertTriangles expected arg#1 to be a table (model)")end;for c=1,#aF do local d0=aF[c]if type(cv)=="table"then d0.outlineColor=cv[d0.c]or d0.outlineColor else d0.outlineColor=cv end end;return aF end;return{newFrame=b4,loadModel=aZ,newBuffer=p,linear=e,models=ct,transforms=c_}